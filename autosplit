#!./miniperl

chdir "lib" if -d "lib";

$package = shift;

# for portability warn about names longer than $maxlen
$maxlen  = 8;	# 8 for dos, 11 (14-".al") for SYSVR3
@toolong = ();

$filename = "$package.pm";
open(IN, $filename) || die "Can't open $filename: $!\n";
while (<IN>) {
    last if /^__END__/;
}
$_ or die "Can't find __END__ in $filename\n";

mkdir "auto", 0777 unless -d "auto";
mkdir "auto/$package", 0777 unless -d "auto/$package";
while (<IN>) {
    if (/^sub ([\w:]+)/) {
	$name = $1;
	push(@toolong, $name) if (length($name) > $maxlen);
	print OUT "1;\n";
	$newname = "auto/$package/$name.al";
	open(OUT, ">$newname") or warn "Can't create $newname: $!\n";
	print OUT <<"END";
# NOTE:  Derived from $package.pm.  Changes made here will be lost.
package $package;

END
    }
    print OUT $_;
}
print OUT "1;\n";

%shorts  = ();
@notuniq = ();
foreach(@toolong){
    my($trunc) = substr($_,0,$maxlen);
    push(@notuniq, $trunc) if $shorts{$trunc};
    $shorts{$trunc} .= " $_";
}

if (@notuniq){
    print "warning: some names are not unique when truncated to $maxlen characters:\n";
    foreach(@notuniq){
	print " $shorts{$_} truncate to $_\n";
    }
}

# end.
